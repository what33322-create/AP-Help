<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AP Exam Center (Synced)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{--primary:#6366f1;--muted:#64748b;--card-shadow:0 6px 18px rgba(17,24,39,0.06)}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#fbfdff,#f3f6ff);color:#0f172a}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{position:sticky;top:0;background:rgba(255,255,255,0.85);border-bottom:1px solid rgba(15,23,42,0.06);z-index:80}
    .header-content{display:flex;justify-content:space-between;align-items:center;padding:12px 20px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--primary);cursor:pointer}
    .nav-buttons{display:flex;gap:8px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:0;font-weight:600;cursor:pointer;background:transparent;color:var(--primary)}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-outline{border:1px solid rgba(99,102,241,0.12)}
    .notification-bar{position:fixed;left:0;right:0;top:68px;display:flex;justify-content:center;pointer-events:none}
    .notification-content{pointer-events:all;background:#fff;border-radius:10px;padding:12px 16px;box-shadow:var(--card-shadow);border-left:4px solid var(--primary);margin:8px;width:min(980px,calc(100% - 40px));display:flex;gap:12px;align-items:center}
    .hidden{display:none !important}
    .page{display:none;padding:20px 0} .page.active{display:block}
    .hero{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:36px;border-radius:14px;margin-bottom:20px;box-shadow:var(--card-shadow)}
    .course-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px}
    .course-card{background:#fff;border-radius:14px;padding:18px;box-shadow:var(--card-shadow);border-left:6px solid var(--primary);cursor:pointer;position:relative}
    .form-group{margin-bottom:12px}.form-label{display:block;font-weight:600;margin-bottom:8px}
    .form-input,.form-select,.form-textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);background:#fff}
    .form-textarea{min-height:120px;resize:vertical}
    .notes-content{background:#fbfdff;border-radius:12px;padding:16px;border:1px solid rgba(15,23,42,0.04)}
    .community-note-editor{background:#fff;border-radius:10px;padding:12px;box-shadow:var(--card-shadow);min-height:160px}
    .rating-stars i{font-size:18px;color:#d1d5db;cursor:pointer}
    .rating-star.active{color:#fbbf24}
    .note-card{background:#fff;border-radius:12px;padding:14px;box-shadow:var(--card-shadow);margin-bottom:12px}
    .note-meta{color:var(--muted);font-size:13px;margin-bottom:6px}
    .stat-card{background:#fff;border-radius:12px;padding:16px;box-shadow:var(--card-shadow);text-align:center}
    .dev-controls{background:#fff;padding:18px;border-radius:12px;box-shadow:var(--card-shadow);margin-bottom:20px}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content container">
      <div class="logo" onclick="showPage('home')"><i class="fas fa-graduation-cap"></i><div>AP Exam Center</div></div>
      <div class="nav-buttons">
        <button class="btn btn-outline" onclick="showPage('community')"><i class="fas fa-users"></i> Community</button>
        <button class="btn btn-outline" onclick="showPage('dev')"><i class="fas fa-code"></i> Dev</button>
        <button id="auth-button" class="btn btn-primary" onclick="showPage('auth')"><i class="fas fa-sign-in-alt"></i> Sign In</button>
      </div>
    </div>
  </header>

  <div id="notification-bar" class="notification-bar hidden" aria-live="polite">
    <div id="notification-content" class="notification-content"><i id="notification-icon" class="fas fa-info-circle"></i><div id="notification-text"></div></div>
  </div>

  <!-- HOME -->
  <main id="home-page" class="page active">
    <div class="container">
      <section class="hero"><h1>Master Your AP Exams</h1><p>Comprehensive study resources, community notes, and AI-powered assistance</p></section>

      <section id="dev-controls" class="dev-controls hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h3 style="margin:0">Developer Controls</h3>
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary" id="add-course-btn"><i class="fas fa-plus"></i> Add Course</button>
            <button class="btn btn-outline" onclick="showPage('dev')"><i class="fas fa-cog"></i> Dev Dashboard</button>
            <button class="btn btn-primary" id="exit-dev-btn"><i class="fas fa-sign-out-alt"></i> Exit Dev Mode</button>
          </div>
        </div>

        <div id="add-course-form" class="hidden" style="margin-top:12px">
          <div class="form-group"><label class="form-label">Course Title</label><input id="new-course-title" class="form-input" placeholder="AP Calculus AB"></div>
          <div class="form-group" style="display:flex;gap:8px">
            <div style="flex:0 0 110px"><label class="form-label">Emoji</label><input id="new-course-emoji" class="form-input" maxlength="2"></div>
            <div style="flex:1"><label class="form-label">Description</label><input id="new-course-description" class="form-input"></div>
          </div>
          <div class="form-group"><label class="form-label">Notes (Markdown or HTML)</label><textarea id="new-course-notes" class="form-textarea" placeholder="# Course Overview"></textarea></div>
          <div style="display:flex;gap:10px"><button class="btn btn-primary" id="save-course-btn"><i class="fas fa-save"></i> Save</button><button class="btn btn-outline" id="cancel-add-course">Cancel</button></div>
        </div>
      </section>

      <section>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h2 style="margin:0">Courses</h2></div>
        <div id="course-grid" class="course-grid" aria-live="polite"></div>
      </section>
    </div>
  </main>

  <!-- COURSE DETAIL -->
  <section id="course-detail-page" class="page">
    <div class="container">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <button class="btn btn-outline" onclick="showPage('home')"><i class="fas fa-arrow-left"></i> Back</button>
        <div><button id="edit-notes-button" class="btn btn-outline hidden"><i class="fas fa-edit"></i> Edit Notes</button></div>
      </div>
      <h1 id="course-detail-title"></h1>

      <div class="section">
        <h3>Course Notes</h3>
        <div id="notes-dropdowns" class="notes-content" style="margin-top:10px"></div>

        <div id="course-notes-editor-wrapper" class="notes-editor hidden" style="margin-top:12px">
          <div class="editor-toolbar">
            <button class="btn btn-outline" onclick="formatSelection('bold')"><i class="fas fa-bold"></i></button>
            <button class="btn btn-outline" onclick="formatSelection('italic')"><i class="fas fa-italic"></i></button>
            <button class="btn btn-outline" onclick="insertBlock('h1')">H1</button>
            <button class="btn btn-outline" onclick="insertBlock('h2')">H2</button>
            <select id="font-size-select" onchange="setFontSize(this.value)"><option value="">Font</option><option value="14px">S</option><option value="18px">M</option><option value="22px">L</option></select>
            <button class="btn btn-outline" onclick="insertDropdownSection()"><i class="fas fa-caret-square-down"></i></button>
            <button class="btn btn-primary" id="save-course-notes"><i class="fas fa-save"></i> Save</button>
            <button class="btn btn-outline" id="cancel-course-edit">Cancel</button>
          </div>
          <div id="course-notes-editor" class="course-notes-editor" contenteditable="true"></div>
        </div>
      </div>

      <div class="section">
        <h3>Useful Links</h3>
        <div id="links-grid" class="links-grid" style="margin-top:10px"></div>
        <div style="margin-top:10px"><button class="btn btn-primary" id="add-link-btn"><i class="fas fa-plus"></i> Add Link</button>
          <div id="add-link-form" class="hidden" style="margin-top:12px">
            <div class="form-group"><label class="form-label">Title</label><input id="new-link-title" class="form-input"></div>
            <div class="form-group"><label class="form-label">URL</label><input id="new-link-url" class="form-input"></div>
            <div style="display:flex;gap:8px"><button class="btn btn-primary" id="save-link-btn">Save</button><button class="btn btn-outline" id="cancel-link-btn">Cancel</button></div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>AI Study Assistant</h3>
        <div id="chat-container" class="notes-content" style="min-height:140px;margin-top:10px"></div>
      </div>
    </div>
  </section>

  <!-- COMMUNITY -->
  <section id="community-page" class="page">
    <div class="container">
      <h1 style="margin-bottom:12px"><i class="fas fa-users"></i> Community Notes</h1>

      <div class="note-card upload-card" style="margin-bottom:16px">
        <h3 style="margin-bottom:8px">Share Your Notes</h3>
        <div class="form-group"><label class="form-label">Course</label><select id="upload-course-select" class="form-select"></select></div>
        <div class="form-group"><label class="form-label">Note Title</label><input id="upload-note-title" class="form-input"></div>
        <div class="form-group"><label class="form-label">Note Content</label>
          <div class="editor-toolbar" style="margin-bottom:8px">
            <button class="btn btn-outline" onclick="uploadEditorFormat('bold')"><i class="fas fa-bold"></i></button>
            <button class="btn btn-outline" onclick="uploadEditorFormat('italic')"><i class="fas fa-italic"></i></button>
            <button class="btn btn-outline" onclick="uploadEditorInsert('h1')">H1</button>
            <button class="btn btn-outline" onclick="uploadEditorInsert('h2')">H2</button>
            <select id="upload-font-size" onchange="uploadEditorSetFontSize(this.value)"><option value="">Font</option><option value="14px">S</option><option value="18px">M</option><option value="22px">L</option></select>
            <button class="btn btn-outline" onclick="uploadEditorInsertDropdown()"><i class="fas fa-caret-square-down"></i></button>
          </div>
          <div id="upload-note-editor" class="community-note-editor" contenteditable="true"></div>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px"><button class="btn btn-primary" id="share-note-btn"><i class="fas fa-upload"></i> Share Note</button><div id="upload-guest-message" style="color:var(--muted);align-self:center;display:none"><i class="fas fa-lock"></i> Sign in to share</div></div>
      </div>

      <div class="section filter-container">
        <h3 style="margin-bottom:8px">Filter Notes</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <div style="flex:1"><label class="form-label">Course</label><select id="filter-course" class="form-select" onchange="applyFilters()"><option value="">All Courses</option></select></div>
          <div style="width:160px"><label class="form-label">Minimum Rating</label><select id="filter-rating" class="form-select" onchange="applyFilters()"><option value="">Any</option><option value="5">5</option><option value="4">4+</option><option value="3">3+</option><option value="2">2+</option><option value="1">1+</option></select></div>
          <div style="width:180px"><label class="form-label">Sort By</label><select id="filter-sort" class="form-select" onchange="applyFilters()"><option value="rating">Rating</option><option value="newest">Newest</option><option value="oldest">Oldest</option></select></div>
        </div>
      </div>

      <div id="community-notes-list" aria-live="polite" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- NOTE VIEW -->
  <section id="note-view-page" class="page">
    <div class="container">
      <div class="note-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <button class="btn btn-outline" onclick="showPage('community')"><i class="fas fa-arrow-left"></i> Back</button>
            <h1 id="view-note-title" style="display:inline-block;margin-left:12px"></h1>
            <div id="view-note-meta" class="note-meta" style="margin-top:6px"></div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="delete-community-note-button" class="btn btn-danger hidden" onclick="handleDeleteCurrentNote()"><i class="fas fa-trash"></i> Delete</button>
          </div>
        </div>

        <div style="margin-top:12px" id="view-note-rating" class="rating-display">
          <div class="rating-stars" id="view-rating-stars"></div>
          <span id="view-rating-text" style="margin-left:8px;color:var(--muted)"></span>
        </div>

        <div id="user-rating-section" class="rating-container" style="margin-top:12px;display:none">
          <label class="form-label" style="min-width:110px">Rate these notes</label>
          <div class="rating-stars" id="user-rating-stars"></div>
          <div style="color:var(--muted);font-size:13px;margin-left:8px">Click a star to submit</div>
        </div>

        <div id="view-note-content" class="markdown-content" style="margin-top:12px"></div>
      </div>
    </div>
  </section>

  <!-- DEV DASHBOARD -->
  <section id="dev-page" class="page">
    <div class="container">
      <h1 style="margin-bottom:12px"><i class="fas fa-code"></i> Developer Dashboard</h1>

      <div id="dev-password-section" style="background:#fff;padding:18px;border-radius:12px;box-shadow:var(--card-shadow);margin-bottom:12px">
        <h3 style="margin-bottom:8px">Developer Access</h3>
        <div style="display:flex;gap:10px;align-items:center">
          <input id="dev-password" class="form-input" type="password" placeholder="Developer password">
          <button class="btn btn-primary" id="enable-dev-btn"><i class="fas fa-unlock"></i> Enable Dev Mode</button>
        </div>
      </div>

      <div id="dev-content" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="stat-card"><div id="total-users" style="font-weight:800;color:var(--primary);font-size:20px">0</div><div style="color:var(--muted)">Total Users</div></div>
            <div class="stat-card"><div id="guest-users" style="font-weight:800;color:var(--primary);font-size:20px">0</div><div style="color:var(--muted)">Guest Users</div></div>
            <div class="stat-card"><div id="total-notes" style="font-weight:800;color:var(--primary);font-size:20px">0</div><div style="color:var(--muted)">Community Notes</div></div>
          </div>
          <div><button class="btn btn-danger" id="exit-dev-btn-2">Exit Dev Mode</button></div>
        </div>

        <div style="display:flex;gap:18px;align-items:flex-start">
          <div style="flex:1">
            <div style="margin-bottom:12px"><input id="dev-course-search" class="form-input" placeholder="Search classes by name..." oninput="searchCoursesInDev()"></div>
            <div id="dev-course-search-results" style="background:#fff;border-radius:12px;padding:12px;box-shadow:var(--card-shadow);max-height:260px;overflow:auto"></div>

            <div style="margin-top:16px">
              <h3 style="margin-bottom:8px">Registered Users</h3>
              <div style="background:#fff;border-radius:12px;padding:12px;box-shadow:var(--card-shadow)"><table style="width:100%"><thead><tr><th style="text-align:left">Name</th><th style="text-align:left">Email</th><th style="text-align:left">Registered</th></tr></thead><tbody id="users-table-body"></tbody></table></div>
            </div>
          </div>

          <div style="width:420px">
            <h3 style="margin-bottom:8px">Recent Activity</h3>
            <div style="background:#fff;border-radius:12px;padding:12px;box-shadow:var(--card-shadow);max-height:420px;overflow:auto"><table style="width:100%"><thead><tr><th>Event</th><th>User</th><th>When</th></tr></thead><tbody id="activity-table-body"></tbody></table></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- AUTH -->
  <section id="auth-page" class="page">
    <div class="container">
      <div style="max-width:480px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;box-shadow:var(--card-shadow)">
        <h2 id="auth-title">Sign In</h2>
        <form id="auth-form" style="margin-top:12px">
          <div id="name-field" class="form-group hidden"><label class="form-label">Name</label><input id="auth-name" class="form-input"></div>
          <div class="form-group"><label class="form-label">Email</label><input id="auth-email" class="form-input" type="email" required></div>
          <div class="form-group"><label class="form-label">Password</label><input id="auth-password" class="form-input" type="password" required></div>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn btn-primary" id="auth-submit-btn" type="button">Sign In</button>
            <button type="button" class="btn btn-outline" id="auth-toggle-btn">Sign Up</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- client-sync import + app logic -->
  <script type="module">
    // Adjust this path if you placed client-sync.js elsewhere
    import {
      loadRemoteData,
      createRemoteNote,
      rateRemoteNote,
      createRemoteCourse,
      editRemoteCourse,
      deleteRemoteNote,
      signupRemote,
      loginRemote
    } from '/public/js/client-sync.js';

    // Simple helpers + local fallback (keeps previously implemented UI functions)
    function showNotification(msg, type='info'){
      const bar = document.getElementById('notification-bar');
      const content = document.getElementById('notification-content');
      const text = document.getElementById('notification-text');
      text.textContent = msg;
      content.className = 'notification-content';
      if(type==='success') content.classList.add('notification-success');
      if(type==='error') content.classList.add('notification-error');
      bar.classList.remove('hidden');
      setTimeout(()=>bar.classList.add('hidden'), 2600);
    }

    // Minimal local helpers (used when remote fails)
    function saveLocalCache(){ localStorage.setItem('apExamAppData', JSON.stringify(window.appData)); }

    // Wire up UI events that call remote functions
    document.addEventListener('DOMContentLoaded', async () => {
      // Attempt to load from server (falls back to localStorage inside the helper)
      try {
        await loadRemoteData();
        showNotification('Loaded data from server', 'success');
      } catch (err) {
        console.warn('Could not load remote data, falling back to local cache', err);
        const saved = localStorage.getItem('apExamAppData');
        if (saved) window.appData = JSON.parse(saved);
      }

      // Initialize UI state
      updateUI();
      renderCourseGrid();
      renderCommunityPage();
      renderDevDashboard();

      // Attach UI button handlers
      document.getElementById('add-course-btn').addEventListener('click', ()=>{ if(!window.developerModeEnabled){ showNotification('Enable dev mode to add courses','error'); return } document.getElementById('add-course-form').classList.toggle('hidden'); });
      document.getElementById('exit-dev-btn').addEventListener('click', exitDeveloperMode);
      document.getElementById('save-course-btn').addEventListener('click', async () => {
        // Create course via remote
        if(!window.developerModeEnabled){ showNotification('Enable dev mode','error'); return; }
        const title = document.getElementById('new-course-title').value.trim();
        const icon = document.getElementById('new-course-emoji').value.trim();
        const desc = document.getElementById('new-course-description').value.trim();
        const notes = document.getElementById('new-course-notes').value.trim();
        if(!title || !desc){ showNotification('Title & description required','error'); return; }
        try {
          const course = await createRemoteCourse({ title, icon, description: desc, notes });
          showNotification('Course created on server', 'success');
          document.getElementById('add-course-form').classList.add('hidden');
          document.getElementById('new-course-title').value=''; document.getElementById('new-course-emoji').value=''; document.getElementById('new-course-description').value=''; document.getElementById('new-course-notes').value='';
          renderCourseGrid();
        } catch (err) {
          console.error(err);
          showNotification('Failed to create course (server)', 'error');
        }
      });

      // Course notes save
      document.getElementById('save-course-notes').addEventListener('click', async () => {
        if(!window.developerModeEnabled || !window.currentCourse){ showNotification('Not allowed','error'); return; }
        const html = document.getElementById('course-notes-editor').innerHTML;
        try {
          await editRemoteCourse(window.currentCourse.id, { notes: html });
          await loadRemoteData();
          renderCourseDetail();
          showNotification('Notes saved to server', 'success');
        } catch(err){
          console.error(err);
          // fallback: update local cache
          window.currentCourse.notes = html;
          const idx = window.appData.courses.findIndex(c=>c.id===window.currentCourse.id);
          if(idx!==-1) window.appData.courses[idx] = window.currentCourse;
          saveLocalCache();
          renderCourseDetail();
          showNotification('Saved locally (offline)', 'info');
        }
      });

      // Share community note
      document.getElementById('share-note-btn').addEventListener('click', async () => {
        if(!window.currentUser){ showNotification('Please sign in to share notes','error'); return; }
        const courseId = parseInt(document.getElementById('upload-course-select').value);
        const title = document.getElementById('upload-note-title').value.trim();
        const content = document.getElementById('upload-note-editor').innerHTML.trim();
        if(!courseId || !title || !content){ showNotification('Fill fields','error'); return; }
        try {
          await createRemoteNote({ courseId, title, content, authorId: window.currentUser.id });
          await loadRemoteData();
          renderCommunityPage();
          showNotification('Note uploaded to server', 'success');
          document.getElementById('upload-course-select').value=''; document.getElementById('upload-note-title').value=''; document.getElementById('upload-note-editor').innerHTML='';
        } catch (err) {
          console.error(err);
          showNotification('Failed to upload (server). Try again later.', 'error');
        }
      });

      // Dev enable
      document.getElementById('enable-dev-btn').addEventListener('click', () => {
        const pw = document.getElementById('dev-password').value;
        if (pw === '6767'){ window.developerModeEnabled = true; updateDeveloperMode(); showNotification('Developer mode enabled','success'); } else showNotification('Incorrect password','error');
      });
      document.getElementById('exit-dev-btn-2').addEventListener('click', exitDeveloperMode);

      // Auth handlers
      document.getElementById('auth-submit-btn').addEventListener('click', async () => {
        const email = document.getElementById('auth-email').value.trim();
        const pw = document.getElementById('auth-password').value;
        const nameField = document.getElementById('auth-name').value.trim();
        const isSignUp = document.getElementById('name-field').classList.contains('hidden') === false;
        if(isSignUp){
          if(!nameField){ showNotification('Enter name','error'); return; }
          try {
            await signupRemote({ name: nameField, email, password: pw });
            // after signup, login locally via loginRemote to populate currentUser
            const user = await loginRemote({ email, password: pw });
            window.currentUser = user;
            saveLocalCache();
            updateUI();
            showPage('home');
            showNotification('Signed up and signed in', 'success');
          } catch(err){ console.error(err); showNotification('Signup failed', 'error'); }
        } else {
          try {
            const user = await loginRemote({ email, password: pw });
            window.currentUser = user;
            saveLocalCache();
            updateUI();
            showPage('home');
            showNotification('Signed in', 'success');
          } catch(err){ console.error(err); showNotification('Login failed', 'error'); }
        }
      });
      document.getElementById('auth-toggle-btn').addEventListener('click', () => {
        const nameField = document.getElementById('name-field');
        const authTitle = document.getElementById('auth-title');
        const authBtn = document.getElementById('auth-submit-btn');
        if(nameField.classList.contains('hidden')){ nameField.classList.remove('hidden'); authTitle.textContent='Sign Up'; authBtn.textContent='Sign Up'; } else { nameField.classList.add('hidden'); authTitle.textContent='Sign In'; authBtn.textContent='Sign In'; }
      });

      // search in dev
      document.getElementById('dev-course-search').addEventListener('input', () => {
        if(!window.developerModeEnabled) return;
        const q = document.getElementById('dev-course-search').value.trim().toLowerCase();
        const resultsEl = document.getElementById('dev-course-search-results'); resultsEl.innerHTML='';
        if(!q) return;
        const matches = (window.appData.courses||[]).filter(c=>c.title.toLowerCase().includes(q));
        if(matches.length===0){ resultsEl.innerHTML='<div style="color:var(--muted)">No classes found</div>'; return; }
        matches.forEach(c=>{
          const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.padding='8px'; div.style.borderBottom='1px dashed rgba(15,23,42,0.04)';
          div.innerHTML = `<div><strong>${escapeHtml(c.title)}</strong><div style="color:var(--muted);font-size:13px">${escapeHtml(c.description)}</div></div><div style="display:flex;gap:8px"><button class="btn btn-outline" onclick="openCourse('${c.id}')">Open</button><button class="btn btn-primary" onclick="(function(){ editCourse('${c.id}'); })()"><i class="fas fa-edit"></i></button></div>`;
          resultsEl.appendChild(div);
        });
      });

      // wire rating stars click handling globally (delegated)
      document.getElementById('user-rating-stars').addEventListener('click', (ev) => {
        const t = ev.target;
        if(!t || !t.dataset) return;
        // handled by buildUserRatingStars function which binds events directly. This is just a fallback.
      });
    }); // DOMContentLoaded end

    // --- Reuse app logic (adapted to call server helpers above) ---
    // Most helper functions below mirror the UI logic and call remote helpers when appropriate.

    // expose some global state used by UI code
    window.appData = window.appData || { courses: [], communityNotes: [], users: [], analytics: { sessions: [] } };
    window.currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    window.currentCourse = null;
    window.currentNote = null;
    window.developerModeEnabled = false;
    window.userRating = 0;

    // Update UI header/auth button
    function updateUI(){
      const btn = document.getElementById('auth-button');
      if(window.currentUser){ btn.innerHTML = `<i class="fas fa-sign-out-alt"></i> ${escapeHtml(window.currentUser.name)}`; btn.onclick = ()=> signOut(); } else { btn.innerHTML = `<i class="fas fa-sign-in-alt"></i> Sign In`; btn.onclick = ()=> showPage('auth'); }
      // show/hide dev controls section
      document.getElementById('dev-controls').classList.toggle('hidden', !window.developerModeEnabled);
      // update guest message
      document.getElementById('upload-guest-message').style.display = window.currentUser ? 'none' : 'block';
    }

    // Courses rendering
    function renderCourseGrid(){
      const grid = document.getElementById('course-grid'); grid.innerHTML='';
      (window.appData.courses || []).forEach(course=>{
        const card = document.createElement('div'); card.className='course-card'; card.onclick = ()=> openCourse(course.id);
        card.innerHTML = `<button class="delete-course" title="Delete course" onclick="event.stopPropagation(); deleteCourse('${course.id}')"><i class="fas fa-trash"></i></button><button class="edit-course" title="Edit notes" onclick="event.stopPropagation(); editCourse('${course.id}')"><i class="fas fa-edit"></i></button><div class="course-emoji">${course.icon||''}</div><div class="course-title">${escapeHtml(course.title)}</div><div class="course-description">${escapeHtml(course.description)}</div>`;
        grid.appendChild(card);
      });
    }

    function openCourse(courseId){ window.currentCourse = (window.appData.courses||[]).find(c=>c.id===courseId); if(window.currentCourse) { renderCourseDetail(); showPage('course-detail'); } }
    function editCourse(courseId){ openCourse(courseId); setTimeout(()=>{ if(!window.developerModeEnabled){ showNotification('Enable dev mode to edit','error'); showPage('dev'); return } toggleCourseEditor(true); },120) }
    async function deleteCourse(courseId){
      if(!window.developerModeEnabled){ showNotification('Only devs can delete courses','error'); return; }
      if(!confirm('Delete course?')) return;
      try {
        // delete course via remote by updating the entire course list (server doesn't have delete endpoint here)
        // Fallback: modify local cache then save to server via editRemoteCourse if you add delete on server.
        window.appData.courses = (window.appData.courses||[]).filter(c=>c.id!==courseId);
        saveLocalCache();
        renderCourseGrid();
        showNotification('Course removed locally. Sync server manually if needed.', 'info');
      } catch (err) {
        console.error(err);
        showNotification('Failed to delete course', 'error');
      }
    }

    // Course detail
    function renderCourseDetail(){
      if(!window.currentCourse) return;
      document.getElementById('course-detail-title').textContent = window.currentCourse.title;
      const el = document.getElementById('notes-dropdowns');
      const raw = window.currentCourse.notes || '';
      el.innerHTML = containsHTML(raw) ? raw : parseMarkdown(raw);
      renderLinks();
      initializeChat();
      document.getElementById('edit-notes-button').classList.toggle('hidden', !window.developerModeEnabled);
      document.getElementById('course-notes-editor-wrapper').classList.add('hidden');
      showPage('course-detail');
    }

    function renderLinks(){
      const grid = document.getElementById('links-grid'); grid.innerHTML='';
      if(!window.currentCourse || !window.currentCourse.links) return;
      window.currentCourse.links.forEach((link, idx) => {
        const c = document.createElement('div'); c.className='link-card';
        c.innerHTML = `<div style="font-size:14px"><strong>${escapeHtml(link.title)}</strong><div style="color:var(--muted);font-size:13px">${escapeHtml(link.url)}</div></div><div><button class="btn btn-outline" onclick="window.open('${escapeAttr(link.url)}','_blank')"><i class="fas fa-external-link-alt"></i></button> <button class="btn btn-outline" onclick="deleteLink(${idx})"><i class="fas fa-trash"></i></button></div>`;
        grid.appendChild(c);
      });
    }
    function deleteLink(idx){ if(!window.developerModeEnabled){ showNotification('Enable dev mode to delete link','error'); return } window.currentCourse.links.splice(idx,1); try{ editRemoteCourse(window.currentCourse.id, { links: window.currentCourse.links }); }catch(e){ saveLocalCache(); } renderLinks(); showNotification('Link removed','success'); }

    // Course editor utilities
    function toggleCourseEditor(open){
      if(!window.developerModeEnabled){ showNotification('Enable dev mode','error'); return; }
      const wrapper = document.getElementById('course-notes-editor-wrapper'), viewer = document.getElementById('notes-dropdowns'), editBtn = document.getElementById('edit-notes-button');
      if(open){
        let content = window.currentCourse.notes || '';
        if(!containsHTML(content)) content = parseMarkdown(content);
        document.getElementById('course-notes-editor').innerHTML = content;
        wrapper.classList.remove('hidden'); viewer.classList.add('hidden'); editBtn.classList.add('hidden');
      } else { wrapper.classList.add('hidden'); viewer.classList.remove('hidden'); editBtn.classList.remove('hidden'); }
    }

    // CHAT placeholder
    function initializeChat(){
      const container = document.getElementById('chat-container');
      container.innerHTML = window.currentUser ? `<div style="padding:12px;color:var(--muted)">AI chat available — send messages to your server endpoint /api/ai.</div>` : `<div style="padding:12px;color:var(--muted)">Sign in to use the AI assistant.</div>`;
    }

    // COMMUNITY: render, create, filter
    function renderCommunityPage(){
      const uploadSelect = document.getElementById('upload-course-select'); const filterSelect = document.getElementById('filter-course');
      uploadSelect.innerHTML = '<option value="">Select a course</option>'; filterSelect.innerHTML = '<option value="">All Courses</option>';
      (window.appData.courses||[]).forEach(c=>{ const o=document.createElement('option'); o.value = c.id; o.textContent = c.title; uploadSelect.appendChild(o); const f=document.createElement('option'); f.value=c.id; f.textContent=c.title; filterSelect.appendChild(f); });
      document.getElementById('upload-guest-message').style.display = window.currentUser ? 'none' : 'block';
      applyFilters();
    }

    async function applyFilters(){
      const courseFilter=document.getElementById('filter-course').value;
      const ratingFilter=document.getElementById('filter-rating').value;
      const sortBy=document.getElementById('filter-sort').value;
      let notes = (window.appData.communityNotes || []).slice();
      if(courseFilter) notes = notes.filter(n=>n.courseId==courseFilter);
      if(ratingFilter) notes = notes.filter(n=> (n.averageRating||0) >= parseInt(ratingFilter));
      notes.sort((a,b)=>{ if(sortBy==='rating') return (b.averageRating||0)-(a.averageRating||0); if(sortBy==='newest') return new Date(b.createdAt)-new Date(a.createdAt); if(sortBy==='oldest') return new Date(a.createdAt)-new Date(b.createdAt); return (b.averageRating||0)-(a.averageRating||0); });
      renderCommunityNotes(notes);
    }

    function renderCommunityNotes(notes){
      const list = document.getElementById('community-notes-list'); list.innerHTML='';
      notes.forEach(note=>{
        const course = (window.appData.courses||[]).find(c=>c.id===note.courseId);
        const card = document.createElement('div'); card.className='note-card';
        const ratingStars = generateRatingStars(note.averageRating||0);
        const ratingsCount = note.ratings ? note.ratings.length : 0;
        const deleteButtonHtml = window.developerModeEnabled ? `<button class="btn btn-danger" onclick="handleDeleteNote('${note.id}')"><i class="fas fa-trash"></i> Delete</button>` : '';
        card.innerHTML = `<div class="note-meta">${course ? escapeHtml(course.title) : 'Unknown'} • by ${escapeHtml(note.author)} • ${new Date(note.createdAt).toLocaleDateString()}</div><h3 style="margin:6px 0">${escapeHtml(note.title)}</h3><div class="rating-display">${ratingStars} <span style="margin-left:8px;color:var(--muted)">${ratingsCount} ratings</span></div><div class="note-actions" style="margin-top:8px"><button class="btn btn-outline" onclick="viewNote('${note.id}')"><i class="fas fa-eye"></i> View</button>${deleteButtonHtml}</div>`;
        list.appendChild(card);
      });
    }

    function generateRatingStars(rating){ let stars=''; for(let i=1;i<=5;i++){ if(rating>=i) stars+='<i class="fas fa-star" style="color:#fbbf24"></i>'; else if(rating>i-1 && rating<i) stars+='<i class="fas fa-star-half-alt" style="color:#fbbf24"></i>'; else stars+='<i class="far fa-star" style="color:#d1d5db"></i>'; } return stars; }

    // NOTE VIEW & RATING (submit via remote)
    function viewNote(noteId){
      const note = (window.appData.communityNotes||[]).find(n=>n.id===noteId); if(!note) return;
      window.currentNote = note;
      document.getElementById('view-note-title').textContent = note.title;
      document.getElementById('view-note-meta').textContent = `by ${note.author} • ${new Date(note.createdAt).toLocaleDateString()}`;
      document.getElementById('view-rating-stars').innerHTML = generateRatingStars(note.averageRating||0);
      document.getElementById('view-rating-text').textContent = `${note.averageRating ? note.averageRating.toFixed(1) : '0'} (${note.ratings ? note.ratings.length : 0} ratings)`;
      const userRatingSection = document.getElementById('user-rating-section');
      if(window.currentUser && window.currentUser.id !== note.authorId){ userRatingSection.style.display = 'flex'; buildUserRatingStars(); } else userRatingSection.style.display = 'none';
      document.getElementById('delete-community-note-button').classList.toggle('hidden', !window.developerModeEnabled);
      const contentEl = document.getElementById('view-note-content'); contentEl.innerHTML = containsHTML(note.content) ? note.content : parseMarkdown(note.content);
      showPage('note-view');
    }

    function buildUserRatingStars(){
      const container = document.getElementById('user-rating-stars'); container.innerHTML='';
      for(let i=1;i<=5;i++){
        const star = document.createElement('i'); star.className='fas fa-star rating-star'; star.dataset.rating=i;
        star.addEventListener('mouseenter', ()=> previewUserRating(i));
        star.addEventListener('mouseleave', ()=> previewUserRating(window.userRating || 0));
        star.addEventListener('click', ()=> { setUserRating(i); submitRating(); });
        container.appendChild(star);
      }
      previewUserRating(0);
    }
    function previewUserRating(rating){ document.querySelectorAll('#user-rating-stars .rating-star').forEach((s,idx)=>{ s.classList.toggle('active', idx+1 <= rating); }); }
    function setUserRating(rating){ window.userRating = rating; previewUserRating(rating); }

    async function submitRating(){
      if(!window.currentUser || !window.currentNote || !window.userRating){ if(!window.userRating) showNotification('Click a star to rate','error'); return; }
      try {
        await rateRemoteNote(window.currentNote.id, window.currentUser.id, window.userRating);
        await loadRemoteData();
        renderCommunityPage();
        viewNote(window.currentNote.id);
        showNotification('Rating saved on server', 'success');
        window.userRating = 0;
      } catch(err){
        console.error(err);
        showNotification('Failed to rate on server', 'error');
      }
    }

    // Delete note (remote)
    async function handleDeleteNote(noteId){
      if(!window.developerModeEnabled){ showNotification('Only devs can delete notes','error'); return; }
      if(!confirm('Delete community note?')) return;
      try {
        await deleteRemoteNote(noteId, { authorId: window.currentUser ? window.currentUser.id : null, forceDev: true });
        await loadRemoteData();
        renderCommunityPage();
        showNotification('Note deleted on server', 'success');
      } catch(err){
        console.error(err); showNotification('Failed to delete on server', 'error');
      }
    }
    function handleDeleteCurrentNote(){ if(window.currentNote) handleDeleteNote(window.currentNote.id); }

    // Community upload editor helpers (formatting)
    function uploadEditorFormat(cmd){ const ed=document.getElementById('upload-note-editor'); ed.focus(); if(cmd==='bold') document.execCommand('bold'); if(cmd==='italic') document.execCommand('italic'); }
    function uploadEditorInsert(tag){ const ed=document.getElementById('upload-note-editor'); ed.focus(); const sel=window.getSelection(); if(!sel||sel.rangeCount===0){ ed.insertAdjacentHTML('beforeend', `<${tag}>Heading</${tag}><br/>`); return; } const range=sel.getRangeAt(0); const content = range.extractContents(); const el=document.createElement(tag); el.appendChild(content); range.insertNode(el); range.collapse(false); }
    function uploadEditorSetFontSize(size){ if(!size) return; const sel=window.getSelection(); if(!sel||sel.isCollapsed) return; const range=sel.getRangeAt(0); const span=document.createElement('span'); span.style.fontSize=size; span.appendChild(range.extractContents()); range.insertNode(span); }
    function uploadEditorInsertDropdown(){ const ed=document.getElementById('upload-note-editor'); const html=`<details><summary>New Section</summary><div style="padding:.5rem 0">Content...</div></details><br/>`; const sel=window.getSelection(); if(sel&&sel.rangeCount){ const range=sel.getRangeAt(0); const node=document.createElement('div'); node.innerHTML=html; const frag=document.createDocumentFragment(); while(node.firstChild) frag.appendChild(node.firstChild); range.insertNode(frag); } else ed.insertAdjacentHTML('beforeend', html); }

    // Dev dashboard helpers
    function renderDevDashboard(){ if(!window.developerModeEnabled){ document.getElementById('dev-password-section').classList.remove('hidden'); document.getElementById('dev-content').classList.add('hidden'); return; } document.getElementById('dev-password-section').classList.add('hidden'); document.getElementById('dev-content').classList.remove('hidden'); document.getElementById('total-users').textContent = (window.appData.users||[]).length || 0; document.getElementById('guest-users').textContent = window.appData.analytics.guestUsers || 0; document.getElementById('total-notes').textContent = (window.appData.communityNotes||[]).length || 0; const usersBody=document.getElementById('users-table-body'); usersBody.innerHTML=''; (window.appData.users||[]).forEach(u=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.email)}</td><td>${new Date(u.createdAt).toLocaleDateString()}</td>`; usersBody.appendChild(tr); }); const actBody=document.getElementById('activity-table-body'); actBody.innerHTML=''; (window.appData.analytics.sessions||[]).slice(-10).reverse().forEach(a=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(a.ev)}</td><td>${escapeHtml(a.userId||'Guest')}</td><td>${new Date(a.timestamp).toLocaleString()}</td>`; actBody.appendChild(tr); }); }

    // Auth helpers (use remote signup/login functions)
    async function signupRemoteWrapper({ name, email, password }){ return signupRemote({ name, email, password }); }
    async function loginRemoteWrapper({ email, password }){ return loginRemote({ email, password }); }

    async function signOut(){ const name = window.currentUser ? window.currentUser.name : 'User'; window.currentUser = null; localStorage.removeItem('currentUser'); updateUI(); showNotification(`Goodbye, ${name}`, 'info'); }

    // Utility functions
    function parseMarkdown(text){ if(!text) return ''; if(containsHTML(text)) return text; let html = text.replace(/^# (.*$)/gm,'<h1>$1</h1>').replace(/^## (.*$)/gm,'<h2>$1</h2>').replace(/^### (.*$)/gm,'<h3>$1</h3>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/^- (.*$)/gm,'<li>$1</li>').replace(/\n/g,'<br>'); html = html.replace(/(<li>.*<\/li>)(<br>)*(?=<li>)/g,'$1').replace(/(<li>.*<\/li>)/g,'<ul>$1</ul>'); return html; }
    function isValidUrl(s){ try{ new URL(s); return true }catch(e){ return false } }
    function saveLocalCache(){ localStorage.setItem('apExamAppData', JSON.stringify(window.appData)); }
    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
    function containsHTML(s){ return /<[^>]+>/.test(s); }

    // Expose a dev clear helper
    window.__dev_clearStorage = ()=>{ if(confirm('Clear app cache?')){ localStorage.removeItem('apExamAppData'); localStorage.removeItem('currentUser'); location.reload(); } };

    // Small bindings for some earlier-called global functions
    window.openCourse = openCourse;
    window.editCourse = editCourse;
    window.deleteCourse = deleteCourse;
    window.uploadEditorFormat = uploadEditorFormat;
    window.uploadEditorInsert = uploadEditorInsert;
    window.uploadEditorSetFontSize = uploadEditorSetFontSize;
    window.uploadEditorInsertDropdown = uploadEditorInsertDropdown;
    window.viewNote = viewNote;
    window.handleDeleteNote = handleDeleteNote;
    window.handleDeleteCurrentNote = handleDeleteCurrentNote;

    // End module script
  </script>
</body>
</html>
